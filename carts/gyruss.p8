pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

local time_t=0

local rspr_clear_col=14
function rspr(sx,sy,x,y,a,w)
	local ca,sa=cos(a),sin(a)
	local srcx,srcy,addr,pixel_pair
	local ddx0,ddy0=ca,sa
	local mask=shl(0xfff8,(w-1))
	w*=4
	ca*=w-0.5
	sa*=w-0.5
	local dx0,dy0=sa-ca+w,-ca-sa+w
	w=2*w-1
	for ix=0,w do
		srcx,srcy=dx0,dy0
		for iy=0,w do
			if band(bor(srcx,srcy),mask)==0 then
				local c=sget(sx+srcx,sy+srcy)
				sset(x+ix,y+iy,c)
			else
				sset(x+ix,y+iy,rspr_clear_col)
			end
			srcx-=ddy0
			srcy+=ddx0
		end
		dx0+=ddx0
		dy0+=ddy0
	end
end

-- world to screen space project
local cam_focal=8
function project(x,y,z)
	local w=cam_focal/(cam_focal+z)
 return 64+x*w,64-y*w,z,w
end

local world_radius=48
local far_plane=24
local actors={}
function make_plyr()
	return add(actors,{
 	x=0,y=0,z=0,
 	angle=0,
 	da=0,
 	-- sprite coords
 	sx=32,
 	sy=0,
 	draw=draw_actor,
 	update=function() 
 	 -- done in control_plyr
 	end})
end
function make_npc()
	local angle=rnd()
	local r=0.8*world_radius
	return add(actors,{
 	x=r*cos(angle),y=-r*sin(angle),z=far_plane,
 	angle=angle,
 	-- sprite coords
 	sx=48,
 	sy=0,
 	draw=draw_actor,
 	update=function(self) 
 		self.z-=0.3
 	 -- allow sprite slightly above camera plane
 		if self.z<=-4 then
 			self.disabled=true
 			del(actors,self)
 			-- create another one!
				make_npc()
			end
 	end})
end

function draw_actor(self)
	-- rotate sprite (using sprite 32/16 as buffer)
	rspr(self.sx,self.sy,32,16,-self.angle,2)	
	
	-- project
	local x,y,z,w=project(self.x,self.y,self.z)
	
	-- display sprite (inc. scaling)
 sspr(32,16,16,16,x-8*w,y-8*w,16*w,16*w)	
end

function control_plyr()
	if(btn(0)) plyr.da=-0.01
	if(btn(1)) plyr.da=0.01
	
	plyr.angle+=plyr.da
	plyr.da*=0.9
	
	local x,y=world_radius*cos(plyr.angle),-world_radius*sin(plyr.angle)
	plyr.x,plyr.y=x,y
	
	if btnp(4) then
		make_part(x,y,plyr.angle+0.5)
	end	
end

local parts={}
function make_part(x,y,a)
	local c,s=3*cos(a),-3*sin(a)
	add(parts,{
		x=x,y=y,z=0,
		dx=c,dy=s,
		t=time_t+30+rnd(16)
	})
end

function update_parts()
	for _,p in pairs(parts) do
		if p.t<time_t or p.z>far_plane then
			del(parts,p)
		else
			p.z+=0.5
		end
	end	
end

function draw_parts()
	for i=1,#parts do
		local p=parts[i]
		local x,y,z,w=project(p.x,p.y,p.z)
		sspr(64,0,8,8,x-4*w,y-4*w,8*w,8*w)
	end
end

function _update60()
	time_t+=1

	control_plyr()
	
	for _,a in pairs(actors) do
		a:update()
	end
	
	update_parts()
end

function _draw()
	cls(0)
	
	palt(0,false)
	palt(14,true)

	draw_stars()
	draw_parts()
	for _,a in pairs(actors) do
		a:draw()
	end
	
	palt()	

	rectfill(0,0,127,8,1)
	print(stat(1),2,2,7)
end

function _init()
	plyr=make_plyr()
	for i=1,5 do
		make_npc()
	end
end

-->8
local stars={}

for i=1,32 do
	add(stars,{rnd(64)-32,rnd(64)-32,rnd(far_plane),dz=rnd()/4})
end

function draw_stars()
	for _,v in pairs(stars) do
		local x,y,z,w=project(v[1],v[2],v[3])
		local c=sget(4*w/2,8)
		pset(x,y,c)
		v[3]-=0.08
		if v[3]<-4 then
			v[1],v[2],v[3]=rnd(48)-24,rnd(48)-24,rnd(far_plane)
		end
	end
end

__gfx__
00000000000000008888888888888888eeeeeeee668eeeeeeee99eeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
00000000000000008999999999999998eeeeeee6668eeeeeee9997eeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
007007000000000089aaaaaaaaaaaa98eeeeee6668eeeeeeee99997eeeeeeeeeee3333ee00000000000000000000000000000000000000000000000000000000
000770000000000089a0000770000a98eeee786682eeeeeeee99990997799eeeee3bb3ee00000000000000000000000000000000000000000000000000000000
000770000000000089a0000770000a98eeee778682eeeeeee9990099999009eeee3bb3ee00000000000000000000000000000000000000000000000000000000
007007000000000089a0000770000a98eee677788eeeeeeee9999990090000eeee3333ee00000000000000000000000000000000000000000000000000000000
000000000000000089a0000770000a98ee6067782cceeeee999777edd9ee999eeeeeeeee00000000000000000000000000000000000000000000000000000000
000000000000000089a7777777777a98e606668277c7ce7eee4466d77d797799eeeeeeee00000000000000000000000000000000000000000000000000000000
156700000000000089a7777777777a98e707778277c7ce7eee4466d77d7977990000000000000000000000000000000000000000000000000000000000000000
000000000000000089a0000770000a98ee7076682cceeeee9997770dd000999e0000000000000000000000000000000000000000000000000000000000000000
000000000000000089a0000770000a98eee766688eeeeeeee9999990090000ee0000000000000000000000000000000000000000000000000000000000000000
000000000000000089a0000770000a98eeee668782eeeeeee9990099999009ee0000000000000000000000000000000000000000000000000000000000000000
000000000000000089a0000770000a98eeee687782eeeeeeee99990997799eee0000000000000000000000000000000000000000000000000000000000000000
000000000000000089aaaaaaaaaaaa98eeeeee7778eeeeeeee99997eeeeeeeee0000000000000000000000000000000000000000000000000000000000000000
00000000000000008999999999999998eeeeeee7778eeeeeee9997eeeeeeeeee0000000000000000000000000000000000000000000000000000000000000000
00000000000000008888888888888888eeeeeeee778eeeeeeee99eeeeeeeeeee0000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11777111117711777177711111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11717111111711117171711111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11717111111711777177711111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11717111111711711111711111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11777117117771777111711111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111
00000000000000000000000000000000000000000000007900d777d0099000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000009900d777d9990777000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000099990ddd09909999000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000099990ddd09909999000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000770999766667790999000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000779900976667799999000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000779900976667799999000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000009999900974449999999000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000009999999994449999000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000009999999990009900000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000009999999990009900000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000009900000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000077088670770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000777786670076000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000028776677600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000002888676600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000022886660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000c77277770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000c77287777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000077cc886880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000070c7c0086600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000700000028600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000088600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

