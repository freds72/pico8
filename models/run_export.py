import os
from subprocess import Popen, PIPE
import re
import tempfile

local_dir = os.path.dirname(os.path.realpath(__file__))
blender_dir = os.path.expandvars("%programfiles%/Blender Foundation/Blender")

def call(args):
    proc = Popen(args, stdout=PIPE, stderr=PIPE)
    out, err = proc.communicate()
    exitcode = proc.returncode
    #
    return exitcode, out, err

# file_list = ['deathstar','junk2','tie','xwing','ywing','title','turret','trench1','vent','mfalcon','generator','tiex1']
# file_list = ['audi','audi_bbox','vtree']
file_list = ['205gti','205gti_bbox']
s = "{:02x}".format(len(file_list))
for blend_file in file_list:
    print("Exporting: {}.blend".format(blend_file))
    fd, path = tempfile.mkstemp()
    try:
        os.close(fd)
        exitcode, out, err = call([os.path.join(blender_dir,"blender.exe"),os.path.join(local_dir,blend_file + ".blend"),"--background","--python",os.path.join(local_dir,"blender_export_uv.py"),"--","--out",path])
        if err:
            raise Exception('Unable to loadt: {}. Exception: {}'.format(blend_file,err))
        print("exit: {} \n out:{}\n err: {}\n".format(exitcode,out,err))
        with open(path, 'r') as outfile:
            s = s + outfile.read()
    finally:
        os.remove(path)

# extra data
# slip angle curve 
s = s + "807e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7e7b7875726f6c696663605d5a5754514e4b4845423f3c393633302d2a2724211f1d1d1c1c1b1b1a1a1919181817171616161515141413131212111110100f0f0f0e0e0d0d0c0c0b0b0a0a09090808070707060605050404030302020101000000"
# slip ratio curve 
s = s + "80676768696a6b6c6d6e6f6f70717273747576777878787877777676757575747473737272717171716e6c6a686664625f5d5b59575553514e4c4a48464442403f3d3c3b3a39373635343331302f2e2d2c2a2928272624232221201e1d1d1c1c1c1c1c1c1c1c1b1b1b1b1b1b1b1b1b1a1a1a1a1a1a1a1a1a191919191919191919"
# track + actors
s = s + "ff00ff00ff00ff00ff00ff00ff00a40008a00948dd0008a20948d70008850911a012510948d50008850911a2128209d20008830911a7128209960008920948a70008830911a8128209950008940948a1000885091189120a9a094a8612820992000883091192125109489f000885091189120a9b091185120a0901910008830911941282099e000809118b120a85090192004184091185120a09018f0008830911971282099e0082098b120a85090193000883091185120a09018f000883091198125109489d00820986120a85090197000883091185120a09018f000883091185120a90094a83125109489c008209861251850997000883091185120a09018f000883091185120a920984128209489b008209871251840996000883091185120a09018f0008091187120a09018e0041820984128309489a0041094a87125183094894000883091185120a09018f0008091187120a0901900041094a83125183099b004183094a85125183094892000883091185120a09018d000883091185120a830901920041094a83125182099c004183094a85125183094890000883091185120a09018d000883091185120a8309019400820984125109489c004183094a87125183094888000885091185120a8309018d000883091185120a8309019500820985125109489c004183094a87125183094886000885091185120a8309018d000883091185120a830901960041094a851282099f004183094a8512518a091189120a8309018d0008091187120a09019a0041094a84128209a0004183094a85125188091189120a8309018d0008091187120a09019c0082094a8312510948a0004183094a96120a8309018d0008091187120a09019d0083094a83125109489f0008840995120a8309018d0008091187120a09019e0041830984128209489b000887098e120a8709018f0008091185120a830901a00041820984128309489900088709118e128709019000820985120a830901a20041094a831251830992000887091195128409019300820984120a0901a60041094a8312518209910008870911961251830948920008091184128209a80082098412820990000809118f120a88094a851251830948900008091185128209a800820984128209900082098f120a8a094a8512518309488e0008820985120a0901a8008209841282099000820988120a87090186004183094a87125109488c0008830984120a0901a9008209841282099000820987120a87090188004183094a871282098c0083091183120a8209a90008091183120a82099000820982120a85090190004183094a861282098c0082091183120a8309a80008091183120a8309900082098212850901910008830911861282098b000809118412830901a7000882098412830901900082098212820901910008830911891282098a000809118512820901a7000883098412820901910082098212820991000883091189120a09018a00820985120a0901a7000883091183120a09019200820982128209900008091189120a8309018b00820984120a090195000895091183120a090193008209821282098f0008091189120a8309018c008209841282099500089509118412820994008209821282098e0008091187120a8309018f008209841282098e0008870911991282099400820982125109488c0008091187120a83090190008209841282098d000887091199120a09019400820983125109488a0008091185120a83090193008209841282098a00088309118f120a9109019500820984128209890008091185120a83090194008209841282098a008309118f120a9109019600820984128209880008091185120a83090195008209841282098a0082091189120a870901a700820984128209870008091185120a83090196008209841282098a00820989120a870901a800820984128209860008091185120a83090197008209841282098a00820984120a850901af008209841282098600820985120a83090198008209841282098a0082098412850901b0008209841282098600820984120a83090199008209841282098a0082098412820901b300820984128209860082098412518309489900820984128209890008091183120a8209b4008209841282098600820987125109489800820984128209880008091183120a8309b400820984128209860041094a87125109489700820984128209880082098412830901b40082098412820987004183094a8512518309489400820984128209880082098412820901b50082098412820988004183094a85125183094893008209841282098800820984128209b60082098412820989004183094a85125183094892008209841282098800820984128209b6008209841282098a004183094a8512518309489100820984125109488700820984128209b6008209841282098d0041094a87125109489000820985125109488600820984128209b6008209841282098e0041094a87125109488f0041094a851282098600820984128209b6008209841282098f004183094a8512518309488d0041094a841282098600820984128209b600820984128209488f004183094a8512518309488d008209841282098600820984128209b600820984128509488d004183094a87125185094888008209841282098600820984128209b60082098412518509488d004183094a87125185094887008209841282098600820984128209b6008209891251870948890041094a8b125183094884008209841282098600820984128209b60041094a891251870948890041094a8b12518309488200088209841282098600820984128209b70041094a8f125185094885004185094a8912518609841282098600820984128209b80041094a8f125185094885004185094a8912518509841282098600820984128209b9004187094a8b125185094885004185094a8912518209841282098600820984128209ba004187094a8b12518509488400080085094a8912511184128209860041094a8312510948c0004185094a8b12518509000184004183094a8c128209870041094a8312510948c0004185094a8b125185094885004183094a8b1282098800820984128209c5004185094a8b1251094887004185094a861282098800820984128209c6004185094a8b1251094887004185094a84120a8209880082098412820948ca004185094a8712518309488900418809880082098412970948b6004185094a87125183094889004186090188008209841251970948b8004185094a851251830948980082099b1251890948b0004185094a851251830948970082099c1251890948b40041094a871251094896008209a512510948b40041094a8712510948950041094aa5128209b5004183094a85125109489500419b094a8a128209b6004183094a851282099600419b094a89128209b7004183094a84128209b1004185094a84128209b80041830984128209b20041850984128209b90041820984128209b50041820984128209b90008820984128209b600820984128209b80008830984128209b600820984128209b80083091183120a0901b50008091184128209b80082091183120a0901b50008091185128209b800820984128209b600820985120a0901b800820984128209b600820984120a0901b80008091183120a8209b600820984128209a2000897091183120a8309b600820984128209a100089709118412830901b6008209841282099e00088309119b12820901b7008209841282099d00088309119c128209b700080911841282099800088509119f128209b600080911851282099700088509119f120a0901b600820985120a090196000809118b120a9909019300088a09489800820984120a0901970082098b120a9909019300088c09489600080911841282099800820986120a850901a900088509118812518b09488a0008091185128209980082098612850901a900088509118a12518b0948880008820985120a0901980082098612820901a700088509119a1251830948840008830984120a0901990041094a8512820948a600088509119c1251830948830083091183120a82099b0041094a8412830948a200088309118b120a88094a8d1251830948820082091183120a83099c0082094a8312518309a100088309118b120a8a094a8d125183094808091184128309019c0083094a8312518209a0000883091187120a85090188004189094a87125182091185128209019d0041830984125109489e000883091187120a8509018a004189094a8712511185120a09019f0041820985125187094894000883091187120a83090198004183094a8a120a0901a10041094a85125187094892000883091187120a8309019a004183094a89128209a30041094a8b125194091187120a830901a0004183094a86128209a40041094a8b125192091187120a830901a2004183094a84120a0901a50041094aa2120a830901a60041880901a70041094aa0120a830901a80041860901a9004187094a98120a830901db004187094a96120a830901e30041980901e70041960901ff00ff00ff00ff00ff00ff00ff00ff00ff00d600018477643445776766776782777661820087777204668277600583777531820032208322144312830024867762268277664207837764208c00012206857762268477678377328f0002857762268477837761910047776446664004668377827764860012332185000221820002422002228200224782777775208400011257777520840034418a00048277776386003783774183000345738b002577754186000383774183001567748b0001346320860001578277418300157762830002342186002331870001577775208300157772830047777520850001122087002333218400267760820002837741860026648700208500025777208200028377632084000467762085000186000366628300248477648400267776208a0022200022830004668477762083002677762083000222840004666485004685777620830026827784000466408300267776208300158677762083000777762083001577628300267776208300158677768400267776208300157762830027777620820001377776847772840026777620820001377762830047777482002255827762244667776284002676648300558277408200026777728200013782772082004666408300222462208200013777748200268377628300157774830002228300046664208400157740000484776283000574208800267776208400157482002784774083000240850002228200277776208400156282002784774087000222004666400067777620830011376082002784774083000282000267664267776424677776830024557720820006837773108300372000478277746782776782777683002682774082000483777184005760028b77208200046555768200268377718300015772068a77762083000111354000278377508300015762278a7776222085001000678377718300137762268a7776266486000282777604758300266640268b777776208500058277720046208200022200048b77777620850015827762000220850004555789777776208500378277408600222022111384776447837777764420830005827774860004666482000124677776402683778377508300678277608600267776208200026777740026827746837771820002837720860026777683000282776200046664268377758200078377870026777620820006827762820022202784773111578277748700078277830026827760840027847775558477860022468277408200278277648400078a774084000484777482004783777082002246827767877740830024678477762000847774000466778377766447847740820004877740028477740026827783777420024783778300278777740284777400278277837762830022644083002788772267837770004782778377628900278877206782776482002782778277764088000227887720677776208200268277827742890004678377666467777402837720820004667777748a0003578377222002442002677776830002442677748500022200108200158377208400026777728300466677827720840046664631820001837720850046664082000283778277208300026782777530820047827760850002228300068377827720830002678377518200068277748a00278377777484000267837773820002837772208800268377764285004666446664820002678377648800268277224666408400022200222083004783777620222022208300268277224777628c0006847724666766648200046683778277728c0002847746837776822226847782777484002242208322144312678777768366847782777202220004677767667767827776678f778277625777402694776667837776675682777446947762248377724784776667897721478777764024837727070911051f06170c0512051706210d2315261a2a17300b3106330a38123a19391e3625332e3533383731392930272828261f27182f1637163a1134072b08220f1e161f1e202514200c1a101516133a0509010a09012006011b0801031101071401052301082001182b011b2a010c0f01100d010f1101131001183301233201243501333a01323601372a013a2801272a01292601261701291a013711013c11012127011e2301171102181302161502141602101802111b020a0d020d10020e0c02120f021410021011020b24020d21021a35021c38022631022634023105023305023505023507023607023709023109022e0902320a02330b02340b02"

# pico-8 map format
# first 4096 bytes -> gfx (shared w/ map)
# second 4096 bytes -> map
if len(s)>=2*8192:
    raise Exception('Data string too long ({})'.format(len(s)))

tmp=s[:8192]
print("__gfx__")
# swap bytes
gfx_data = ""
for i in range(0,len(tmp),2):
    gfx_data = gfx_data + tmp[i+1:i+2] + tmp[i:i+1]
print(re.sub("(.{128})", "\\1\n", gfx_data, 0, re.DOTALL))

map_data=s[8192:]
if len(map_data)>0:
    print("__map__")
    print(re.sub("(.{256})", "\\1\n", map_data, 0, re.DOTALL))

